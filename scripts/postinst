#!/bin/sh
set -e

# SYNOPKG_PKGETC doesn't exist so we create our own
export SYNOPKG_PKGETC="${SYNOPKG_PKGETC:-/var/packages/${SYNOPKG_PKGNAME}/etc}"

export OS="${OS:-linux}"
export ARCH="${ARCH:-}"

if [ "$ARCH" = "" ]; then
    _arch=$(uname -m)
    case "${_arch}" in
      'x86_64')
        export ARCH="amd64"
        ;;
      'aarch64')
        export ARCH="arm64"
        ;;
      *)
        echo "ERROR: unsupported architecture"
        exit 1
        ;;
    esac
fi

export NOMAD_VERSION="${ZNOMAD_VERSION:-1.3.5}"
export NOMAD_URL="${ZNOMAD_URL:-https://releases.hashicorp.com/nomad/${NOMAD_VERSION}/nomad_${NOMAD_VERSION}_${OS}_${ARCH}.zip}"
export NOMAD_SHARE_DIR="${SYNOPKG_PKGDEST_VOL}/${SYNOPKG_PKGNAME}"

# https://help.synology.com/developer-guide/synology_package/script_env_var.html
env > "${NOMAD_SHARE_DIR}/env"
# env > "${SYNOPKG_PKGDEST}/env"

if [ ! -f "${NOMAD_SHARE_DIR}/bin/nomad" ]; then
  if [ ! -f "${SYNOPKG_PKGTMP}/tmp/nomad.zip" ]; then
    curl --create-dirs -Lo "${SYNOPKG_PKGTMP}/nomad.zip" "${NOMAD_URL}"
  fi
  # unzip -o "${SYNOPKG_PKGTMP}/nomad.zip" -d "${NOMAD_SHARE_DIR}/bin"
  7z x -y "${SYNOPKG_PKGTMP}/nomad.zip" -o"${SYNOPKG_PKGDEST}/bin"
  chmod +x "${SYNOPKG_PKGDEST}/bin/nomad"
fi

mkdir -p "${SYNOPKG_PKGETC}/nomad.d"
mkdir -p "${SYNOPKG_PKGVAR}/lib/nomad"

if [ ! -f "${SYNOPKG_PKGETC}/nomad.d/nomad.hcl" ]; then
  cat <<EOF > "${SYNOPKG_PKGETC}/nomad.d/nomad.hcl"
data_dir="${SYNOPKG_PKGVAR}/lib/nomad"
server {
  enabled = true
  bootstrap_expect = 1
}
client {
  enabled = true
}
EOF
fi;

exit 0
