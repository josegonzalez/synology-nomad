#!/bin/sh
set -e

# SYNOPKG_PKGETC doesn't exist so we create our own
export SYNOPKG_PKGETC="${SYNOPKG_PKGETC:-/var/packages/${SYNOPKG_PKGNAME}/etc}"

# https://help.synology.com/developer-guide/synology_package/script_env_var.html
# env > "${NOMAD_SHARE_DIR}/env"
# env > "${SYNOPKG_PKGDEST}/env"

mkdir -p "${SYNOPKG_PKGETC}/nomad.d"
mkdir -p "${SYNOPKG_PKGVAR}/lib/nomad"

if [ ! -f "${SYNOPKG_PKGETC}/nomad.d/nomad.hcl" ]; then
  cat <<EOF > "${SYNOPKG_PKGETC}/nomad.d/nomad.hcl"
data_dir="${SYNOPKG_PKGVAR}/lib/nomad"
server {
  enabled = true
  bootstrap_expect = 1
}
client {
  enabled = true
}
plugin "docker" {
  config {
    allow_privileged = true
    volumes {
      # required for bind mounting host directories
      enabled = true
    }
  }
}
EOF
fi;

exit 0
